"use strict";var x=require("node:stream"),v=require("node:stream/promises"),S=require("node:timers"),R=()=>{},D={timeoutEarlyInMillis:5,timeoutEarlyResponse:()=>{let e=new Error("[AbortError]: The operation was aborted.",{cause:{package:"@middy/core"}});throw e.name="TimeoutError",e},streamifyResponse:!1},B=(e=R,t={})=>{typeof e!="function"&&(t=e,e=R),t={...D,...t},t.timeoutEarly=t.timeoutEarlyInMillis>0,t.beforePrefetch?.();let a=[],s=[],o=[],i=(r={},d={})=>{t.requestStart?.();let c={event:r,context:d,response:void 0,error:void 0,internal:t.internal??{}};return K(c,a,e,s,o,t)},n=t.streamifyResponse?awslambda.streamifyResponse(async(r,d,c)=>{let l=await i(r,c),f=l;l.statusCode&&(f=l.body??"",delete l.body,d=awslambda.HttpResponseStream.from(d,l));let u;if(f._readableState)u=f;else if(typeof f=="string"){function*w(P){let y=0,U=P.length;for(;y<U;)yield P.substring(y,y+16384),y+=16384}u=x.Readable.from(w(f))}if(!u)throw new Error("handler response not a ReadableStream");await(0,v.pipeline)(u,d)}):i;return n.use=r=>{Array.isArray(r)||(r=[r]);for(let d of r){let{before:c,after:l,onError:f}=d;if(c||l||f)c&&n.before(c),l&&n.after(l),f&&n.onError(f);else throw new Error('Middleware must be an object containing at least one key among "before", "after", "onError"')}return n},n.before=r=>(a.push(r),n),n.after=r=>(s.unshift(r),n),n.onError=r=>(o.unshift(r),n),n.handler=r=>(e=r,n),n},h=new AbortController,K=async(e,t,a,s,o,i)=>{let n,r=i.timeoutEarly&&e.context.getRemainingTimeInMillis;try{if(await C(e,t,i),typeof e.response>"u"){i.beforeHandler?.(),h.signal.aborted&&(h=new AbortController);let d=[a(e.event,e.context,{signal:h.signal})];if(r){let c,l=new Promise((f,u)=>{c=()=>{h.abort();try{f(i.timeoutEarlyResponse())}catch(w){u(w)}}});n=(0,S.setTimeout)(c,e.context.getRemainingTimeInMillis()-i.timeoutEarlyInMillis),d.push(l)}e.response=await Promise.race(d),n&&clearTimeout(n),i.afterHandler?.(),await C(e,s,i)}}catch(d){n&&clearTimeout(n),e.response=void 0,e.error=d;try{await C(e,o,i)}catch(c){throw c.originalError=e.error,e.error=c,e.error}if(typeof e.response>"u")throw e.error}finally{await i.requestEnd?.(e)}return e.response},C=async(e,t,a)=>{for(let s of t){a.beforeMiddleware?.(s.name);let o=await s(e);if(a.afterMiddleware?.(s.name),typeof o<"u"){e.response=o;return}}},g=B;var V=/[^a-zA-Z]/g,b=class extends Error{constructor(t,a,s={}){a&&typeof a!="string"&&(s=a,a=void 0),a??=M[t],super(a,s);let o=M[t].replace(V,"");this.name=o.substr(-5)!=="Error"?o+"Error":o,this.status=this.statusCode=t,this.expose=s.expose??t<500}},E=(e,t,a={})=>new b(e,t,a),M={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"(Unused)",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Unordered Collection",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",509:"Bandwidth Limit Exceeded",510:"Not Extended",511:"Network Authentication Required"};var W=/^application\/(.+\+)?json($|;.+)/,F={reviver:void 0,disableContentTypeError:!1},J=(e={})=>{let t={...F,...e};return{before:async s=>{let{headers:o,body:i}=s.event,n=o?.["Content-Type"]??o?.["content-type"];if(!W.test(n)){if(t.disableContentTypeError)return;throw E(415,"Unsupported Media Type",{cause:{package:"@middy/http-json-body-parser",data:n}})}try{let r=s.event.isBase64Encoded?Buffer.from(i,"base64").toString():i;s.event.body=JSON.parse(r,t.reviver)}catch(r){throw E(415,"Invalid or malformed JSON was provided",{cause:{package:"@middy/http-json-body-parser",data:r}})}}}},T=J;var G=["ALPN","C-PEP","C-PEP-Info","CalDAV-Timezones","Content-ID","Content-MD5","DASL","DAV","DNT","ETag","GetProfile","HTTP2-Settings","Last-Event-ID","MIME-Version","Optional-WWW-Authenticate","Sec-WebSocket-Accept","Sec-WebSocket-Extensions","Sec-WebSocket-Key","Sec-WebSocket-Protocol","Sec-WebSocket-Version","SLUG","TCN","TE","TTL","WWW-Authenticate","X-ATT-DeviceId","X-DNSPrefetch-Control","X-UIDH"],A=G.reduce((e,t)=>(e[t.toLowerCase()]=t,e),{}),_=(e,t)=>{let a=e.toLowerCase();return t?A[a]?A[a]:a.split("-").map(s=>(s[0]||"").toUpperCase()+s.substr(1)).join("-"):a},X={canonical:!1,defaultHeaders:{},normalizeHeaderKey:_},Z=(e={})=>{let t={...X,...e},a={};for(let o of Object.keys(t.defaultHeaders))a[t.normalizeHeaderKey(o,t.canonical)]=t.defaultHeaders[o];return{before:async o=>{if(o.event.headers){let i={},n={...a};for(let r of Object.keys(o.event.headers))i[r]=o.event.headers[r],n[t.normalizeHeaderKey(r,t.canonical)]=o.event.headers[r];o.event.headers=n,o.event.rawHeaders=i}if(o.event.multiValueHeaders){let i={},n={...a};for(let r of Object.keys(o.event.multiValueHeaders))i[r]=o.event.multiValueHeaders[r],n[t.normalizeHeaderKey(r,t.canonical)]=o.event.multiValueHeaders[r];o.event.multiValueHeaders=n,o.event.rawMultiValueHeaders=i}}}},H=Z;var O=require("@aws-lambda-powertools/logger"),k=require("@aws-lambda-powertools/logger/middleware"),L=require("@aws-lambda-powertools/tracer"),p=require("@aws-lambda-powertools/metrics"),j=require("@aws-lambda-powertools/tracer/middleware"),z=require("@aws-lambda-powertools/metrics/middleware");var m=class{static makeResults(t,a){return{statusCode:t,body:JSON.stringify(a),headers:{"Access-Control-Allow-Origin":"*"}}}};var I=new O.Logger,$=new L.Tracer,N=new p.Metrics;exports.handler=g().use(T()).use(H()).use((0,k.injectLambdaContext)(I,{logEvent:!0})).use((0,j.captureLambdaHandler)($)).use((0,z.logMetrics)(N)).handler(async e=>{try{return N.addMetric("successfulImageSearch",p.MetricUnit.Count,1,p.MetricResolution.High),m.makeResults(200,{output:"",reference:""})}catch(t){return I.error("Error",{err:t}),m.makeResults(500,{error:"Server side error: please check function logs"})}});
