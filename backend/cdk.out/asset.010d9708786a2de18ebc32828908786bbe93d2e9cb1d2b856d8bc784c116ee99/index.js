"use strict";var R=require("node:stream"),v=require("node:stream/promises"),S=require("node:timers"),P=()=>{},D={timeoutEarlyInMillis:5,timeoutEarlyResponse:()=>{let e=new Error("[AbortError]: The operation was aborted.",{cause:{package:"@middy/core"}});throw e.name="TimeoutError",e},streamifyResponse:!1},B=(e=P,t={})=>{typeof e!="function"&&(t=e,e=P),t={...D,...t},t.timeoutEarly=t.timeoutEarlyInMillis>0,t.beforePrefetch?.();let o=[],s=[],n=[],i=(r={},d={})=>{t.requestStart?.();let c={event:r,context:d,response:void 0,error:void 0,internal:t.internal??{}};return K(c,o,e,s,n,t)},a=t.streamifyResponse?awslambda.streamifyResponse(async(r,d,c)=>{let l=await i(r,c),f=l;l.statusCode&&(f=l.body??"",delete l.body,d=awslambda.HttpResponseStream.from(d,l));let u;if(f._readableState)u=f;else if(typeof f=="string"){function*w(x){let m=0,U=x.length;for(;m<U;)yield x.substring(m,m+16384),m+=16384}u=R.Readable.from(w(f))}if(!u)throw new Error("handler response not a ReadableStream");await(0,v.pipeline)(u,d)}):i;return a.use=r=>{Array.isArray(r)||(r=[r]);for(let d of r){let{before:c,after:l,onError:f}=d;if(c||l||f)c&&a.before(c),l&&a.after(l),f&&a.onError(f);else throw new Error('Middleware must be an object containing at least one key among "before", "after", "onError"')}return a},a.before=r=>(o.push(r),a),a.after=r=>(s.unshift(r),a),a.onError=r=>(n.unshift(r),a),a.handler=r=>(e=r,a),a},h=new AbortController,K=async(e,t,o,s,n,i)=>{let a,r=i.timeoutEarly&&e.context.getRemainingTimeInMillis;try{if(await C(e,t,i),typeof e.response>"u"){i.beforeHandler?.(),h.signal.aborted&&(h=new AbortController);let d=[o(e.event,e.context,{signal:h.signal})];if(r){let c,l=new Promise((f,u)=>{c=()=>{h.abort();try{f(i.timeoutEarlyResponse())}catch(w){u(w)}}});a=(0,S.setTimeout)(c,e.context.getRemainingTimeInMillis()-i.timeoutEarlyInMillis),d.push(l)}e.response=await Promise.race(d),a&&clearTimeout(a),i.afterHandler?.(),await C(e,s,i)}}catch(d){a&&clearTimeout(a),e.response=void 0,e.error=d;try{await C(e,n,i)}catch(c){throw c.originalError=e.error,e.error=c,e.error}if(typeof e.response>"u")throw e.error}finally{await i.requestEnd?.(e)}return e.response},C=async(e,t,o)=>{for(let s of t){o.beforeMiddleware?.(s.name);let n=await s(e);if(o.afterMiddleware?.(s.name),typeof n<"u"){e.response=n;return}}},M=B;var V=/[^a-zA-Z]/g,b=class extends Error{constructor(t,o,s={}){o&&typeof o!="string"&&(s=o,o=void 0),o??=T[t],super(o,s);let n=T[t].replace(V,"");this.name=n.substr(-5)!=="Error"?n+"Error":n,this.status=this.statusCode=t,this.expose=s.expose??t<500}},E=(e,t,o={})=>new b(e,t,o),T={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"(Unused)",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Unordered Collection",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",509:"Bandwidth Limit Exceeded",510:"Not Extended",511:"Network Authentication Required"};var W=/^application\/(.+\+)?json($|;.+)/,F={reviver:void 0,disableContentTypeError:!1},J=(e={})=>{let t={...F,...e};return{before:async s=>{let{headers:n,body:i}=s.event,a=n?.["Content-Type"]??n?.["content-type"];if(!W.test(a)){if(t.disableContentTypeError)return;throw E(415,"Unsupported Media Type",{cause:{package:"@middy/http-json-body-parser",data:a}})}try{let r=s.event.isBase64Encoded?Buffer.from(i,"base64").toString():i;s.event.body=JSON.parse(r,t.reviver)}catch(r){throw E(415,"Invalid or malformed JSON was provided",{cause:{package:"@middy/http-json-body-parser",data:r}})}}}},g=J;var G=["ALPN","C-PEP","C-PEP-Info","CalDAV-Timezones","Content-ID","Content-MD5","DASL","DAV","DNT","ETag","GetProfile","HTTP2-Settings","Last-Event-ID","MIME-Version","Optional-WWW-Authenticate","Sec-WebSocket-Accept","Sec-WebSocket-Extensions","Sec-WebSocket-Key","Sec-WebSocket-Protocol","Sec-WebSocket-Version","SLUG","TCN","TE","TTL","WWW-Authenticate","X-ATT-DeviceId","X-DNSPrefetch-Control","X-UIDH"],A=G.reduce((e,t)=>(e[t.toLowerCase()]=t,e),{}),_=(e,t)=>{let o=e.toLowerCase();return t?A[o]?A[o]:o.split("-").map(s=>(s[0]||"").toUpperCase()+s.substr(1)).join("-"):o},X={canonical:!1,defaultHeaders:{},normalizeHeaderKey:_},Z=(e={})=>{let t={...X,...e},o={};for(let n of Object.keys(t.defaultHeaders))o[t.normalizeHeaderKey(n,t.canonical)]=t.defaultHeaders[n];return{before:async n=>{if(n.event.headers){let i={},a={...o};for(let r of Object.keys(n.event.headers))i[r]=n.event.headers[r],a[t.normalizeHeaderKey(r,t.canonical)]=n.event.headers[r];n.event.headers=a,n.event.rawHeaders=i}if(n.event.multiValueHeaders){let i={},a={...o};for(let r of Object.keys(n.event.multiValueHeaders))i[r]=n.event.multiValueHeaders[r],a[t.normalizeHeaderKey(r,t.canonical)]=n.event.multiValueHeaders[r];n.event.multiValueHeaders=a,n.event.rawMultiValueHeaders=i}}}},H=Z;var O=require("@aws-lambda-powertools/logger"),k=require("@aws-lambda-powertools/logger/middleware"),L=require("@aws-lambda-powertools/tracer"),p=require("@aws-lambda-powertools/metrics"),j=require("@aws-lambda-powertools/tracer/middleware"),z=require("@aws-lambda-powertools/metrics/middleware");var y=class{static makeResults(t,o){return{statusCode:t,body:JSON.stringify(o),headers:{"Access-Control-Allow-Origin":"*"}}}};var N=new O.Logger,$=new L.Tracer,I=new p.Metrics;exports.handler=M().use(g()).use(H()).use((0,k.injectLambdaContext)(N,{logEvent:!0})).use((0,j.captureLambdaHandler)($)).use((0,z.logMetrics)(I)).handler(async(e,t)=>{try{return I.addMetric("successfulTextSearch",p.MetricUnit.Count,1,p.MetricResolution.High),y.makeResults(200,{output:"",reference:""})}catch(o){return N.error("Error",{err:o}),y.makeResults(500,{error:"Server side error: please check function logs"})}});
